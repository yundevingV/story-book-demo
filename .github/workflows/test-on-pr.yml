# .github/workflows/test-on-pr.yml
name: Test on Pull Request

on:
  pull_request:
    branches: [master]
    paths:
      - "@yundeving/story-book-demo-ui/**"
      - ".github/workflows/test-on-pr.yml"

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - project: "chromium"
            browser: "chromium (í¬ë¡¬)"
          - project: "firefox"
            browser: "firefox (íŒŒì´ì–´í­ìŠ¤)"
          - project: "webkit"
            browser: "webkit (ì‚¬íŒŒë¦¬)"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.18.0"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Playwright ì„¤ì¹˜
        run: npx playwright install --with-deps

      - name: ìŠ¤í† ë¦¬ë¶ ë¹Œë“œ
        run: yarn ui build-storybook

      - name: ìŠ¤í† ë¦¬ë¶ ì‹¤í–‰
        run: |
          npx serve -l 6006 @yundeving/story-book-demo-ui/storybook-static &
          echo $! > .storybook-pid

      - name: Publish to Chromatic
        uses: chromaui/action@v1
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          storybookBaseDir: "@yundeving/story-book-demo-ui"
          buildScriptName: build-storybook
          onlyChanged: false

      - name: Chromatic ë¹Œë“œ ê²°ê³¼ ì½”ë©˜íŠ¸
        if: ${{ steps.publish_chromatic.outputs.url != '' }}
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "Storybook preview: ${{ steps.publish_chromatic.outputs.url }}"

      - name: ${{ matrix.browser }} í…ŒìŠ¤íŠ¸ ì‹œì‘
        id: test
        continue-on-error: true
        run: yarn ui test --project=${{ matrix.project }} --reporter=list,html,junit

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹± (${{ matrix.browser }})
        if: always()
        id: parse_results
        run: |
          mkdir -p test-summary

          if [ -f "@yundeving/story-book-demo-ui/test-results/junit.xml" ]; then
            # JUnit XML íŒŒì‹±
            TOTAL=$(grep -o 'tests="[0-9]*"' "@yundeving/story-book-demo-ui/test-results/junit.xml" | grep -o '[0-9]*' | head -1 || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' "@yundeving/story-book-demo-ui/test-results/junit.xml" | grep -o '[0-9]*' | head -1 || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' "@yundeving/story-book-demo-ui/test-results/junit.xml" | grep -o '[0-9]*' | head -1 || echo "0")
            SKIPPED=$(grep -o 'skipped="[0-9]*"' "@yundeving/story-book-demo-ui/test-results/junit.xml" | grep -o '[0-9]*' | head -1 || echo "0")
            
            # í†µê³¼í•œ í…ŒìŠ¤íŠ¸ ìˆ˜ ê³„ì‚°
            PASSED=$((TOTAL - FAILURES - ERRORS - SKIPPED))
            
            # ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
            echo "${{ matrix.project }},$TOTAL,$PASSED,$FAILURES,$ERRORS,$SKIPPED,${{ job.status }}" > test-summary/${{ matrix.project }}.txt
            
            # GitHub Output ì„¤ì •
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILURES" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          else
            echo "0,0,0,0,0,${{ job.status }}" > test-summary/${{ matrix.project }}.txt
            echo "total=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
          fi

      - name: ìŠ¤í† ë¦¬ë¶ ì„œë²„ ì¢…ë£Œ
        if: always()
        run: |
          if [ -f .storybook-pid ]; then
            kill $(cat .storybook-pid) || true
            rm .storybook-pid
          fi

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.project }}
          path: |
            @yundeving/story-book-demo-ui/playwright-report/
            @yundeving/story-book-demo-ui/test-results/
          retention-days: 30

      - name: í…ŒìŠ¤íŠ¸ í†µê³„ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-${{ matrix.project }}
          path: test-summary/${{ matrix.project }}.txt
          retention-days: 1

  # ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ëë‚œ í›„ ì¢…í•© ë³´ê³ ì„œ ìƒì„±
  test-summary:
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³„ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          pattern: test-summary-*
          merge-multiple: true
          path: test-summaries

      - name: PR ëŒ“ê¸€ ìƒì„±
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          # ê° ë¸Œë¼ìš°ì €ë³„ í†µê³„ ìˆ˜ì§‘
          COMMENT="# ğŸ§ª Playwright í…ŒìŠ¤íŠ¸ ê²°ê³¼

          ## ğŸ“Š ë¸Œë¼ìš°ì €ë³„ í…ŒìŠ¤íŠ¸ í†µê³„

          | ë¸Œë¼ìš°ì € | ì‹œë„ | âœ… ì„±ê³µ | âŒ ì‹¤íŒ¨ | âš ï¸ ì—ëŸ¬ | â­ï¸ ìŠ¤í‚µ | ìƒíƒœ |
          |---------|------|---------|---------|---------|---------|------|"

          TOTAL_ALL=0
          PASSED_ALL=0
          FAILED_ALL=0
          ERROR_ALL=0
          SKIPPED_ALL=0

          for browser in chromium firefox webkit; do
            if [ -f "test-summaries/test-summary-$browser.txt" ]; then
              IFS=',' read -r project total passed failed errors skipped status < "test-summaries/test-summary-$browser.txt"
              
              # ìƒíƒœ ì´ëª¨ì§€
              if [ "$status" == "success" ] && [ "$failed" -eq 0 ] && [ "$errors" -eq 0 ]; then
                STATUS_EMOJI="âœ…"
              else
                STATUS_EMOJI="âŒ"
              fi
              
              # ë¸Œë¼ìš°ì € ì´ë¦„
              case $browser in
                chromium)
                  BROWSER_NAME="ğŸŸ¢ Chromium (í¬ë¡¬)"
                  ;;
                firefox)
                  BROWSER_NAME="ğŸ¦Š Firefox (íŒŒì´ì–´í­ìŠ¤)"
                  ;;
                webkit)
                  BROWSER_NAME="ğŸ WebKit (ì‚¬íŒŒë¦¬)"
                  ;;
                *)
                  BROWSER_NAME="$browser"
                  ;;
              esac
              
              COMMENT="$COMMENT
          | $BROWSER_NAME | $total | $passed | $failed | $errors | $skipped | $STATUS_EMOJI |"
              
              TOTAL_ALL=$((TOTAL_ALL + total))
              PASSED_ALL=$((PASSED_ALL + passed))
              FAILED_ALL=$((FAILED_ALL + failed))
              ERROR_ALL=$((ERROR_ALL + errors))
              SKIPPED_ALL=$((SKIPPED_ALL + skipped))
            else
              COMMENT="$COMMENT
          | $browser | - | - | - | - | - | âš ï¸ ê²°ê³¼ ì—†ìŒ |"
            fi
          done

          COMMENT="$COMMENT

          ## ğŸ“ˆ ì „ì²´ ìš”ì•½

          | í•­ëª© | ìˆ˜ |
          |------|-----|
          | ì´ í…ŒìŠ¤íŠ¸ | **$TOTAL_ALL** |
          | âœ… ì„±ê³µ | **$PASSED_ALL** |
          | âŒ ì‹¤íŒ¨ | **$FAILED_ALL** |
          | âš ï¸ ì—ëŸ¬ | **$ERROR_ALL** |
          | â­ï¸ ìŠ¤í‚µ | **$SKIPPED_ALL** |

          ---

          ğŸ“¦ ìƒì„¸ ë¦¬í¬íŠ¸ëŠ” [GitHub Actions Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."

          # PR ëŒ“ê¸€ ì‘ì„±
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"
